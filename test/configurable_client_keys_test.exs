defmodule SSHEx.ConfigurableClientKeysTest do
  use ExUnit.Case

  alias SSHEx.ConfigurableClientKeys

  @key """
  -----BEGIN RSA PRIVATE KEY-----
  MIIEpQIBAAKCAQEAr7CylYwuNUCYjOV7uj0X8ZRVVKlwhKtavL0vtmCiSes/TQ+u
  bQb7787djy4fILh/9ALsvOs6mzmAI9Ye6CxwG2nPhbweD76K/92cAAvbcwWFhKTS
  6q2MY6XhATcORqQmYhi6JToYkz51JFeG0k38TwyiIBaLe4yKTCnZ6F0tIB9szdR8
  pNOoZTMDAjXRDA1T0Y1wgxXn5dCFR4ywDcphRTu18FWhulruyPGQjRjFRzZCF8rO
  PYRCVBaWCIQ9Guj6VnAOaPH3tIkkdTxAeMigflCsCbFttbKLSVbi+woQrOnpQt1G
  T9YPaZed9vuXXJMI5IzUacoveyqr/X5cOfdVjwIDAQABAoIBAQCWJHRJt1WZ7s0v
  w8H8A8/dhT1zL6ZXyrStjSQkQOsQLrmXGqqexBQz+V6AyRKS/PlkR8eXH5OjKf2n
  IoqhMbDQzJkrmfs6y0SwqutxYrC02GglVlJledD7K7xhNHK/zfJ7bNRPkhmEZCDp
  4N74BOt1hr9amsmy2QUrV6zAljhFNQtGXlMIzjSwkhAO5RyVDdNUIuXVbK4vYQ8n
  60LAFUqrNMU0H5P7N1I9Wv1XdVroQ23bZkkoQ2YNg3+Xt8/ma1R8ImliODq593EF
  EWDdtcm6gUeKfZSmu3V3XLX2w03/xng9PiQJWhDyGiiqylLWw61V72BOfk8Lsq03
  bCI8HP5pAoGBANmMlI31H1E6zNrJ5/1+2IETRLJhwhCE5SJ14UgHpGjzWpCRVoi1
  KY+N6FfUgReMn6efFtJj59cKUxkODDr4yt+8mfM0evfIUJumQ56czDv5l2m3dnm1
  0JOX4jIwetFv0ROrbk7EONkg4BYLV3OFlekB+iNR0cW3mtPM/x35hvbbAoGBAM6+
  Icf5pDwvU9tqgBlbYdN9D8IJa2kTC2818XAeEBcnDsQNrpKNGfG7jcOb7Os7Qs4q
  ArIrfaWKH5OnRv8sxEJzvR1yQ7zfN0qL5+FgI95/5GmNzmiIOMIRltszuqvXhEbf
  VfxoEOrYidiliI1P2oSkaSHnKh06vTcX/Iuve3hdAoGAPLahFuUb8l2Iol7K4dIu
  tgccmvPxZw7Pq8heMO4BElEoK0SEc+6rRKcD+s8Rn/Lc87jQc7LyFu+ItWtYOnUI
  mVxXUqqIzvIWnPnP0UpNLUfA2/4ZkGoPZcFznTIudJjSLr0fMdhNTTuBjmVn6JOV
  fMvSdVz2QEm3afjCEil7YxUCgYEAkSPH4XUvyJTNQTfGUIbn6apdurIUNwMIvv1W
  z4g7cZWY9yhHy1jFwwARqSa5L/c9kjDKDb0ci2+pdWY1IIWUDrbkKF0Ekv79+Ra5
  Jm7xH44Xk8bbBmXDuvLQPnlVbrhxg7Pc0MNaRRTZyT+E2vgZh49Iw2VfGoAXQCtV
  v9blTn0CgYEAoaLnpcDDIAJrSEuYJlmMkCSOLnDaUJ2Gvk7h8J3AKUJqaZKDrYtp
  LkmEnkNn9pRguHw5O4t2A2/MPTMMPl9okxWUxmFol6vrLcVWJ7fHKnAgN4VeVdmV
  3wC+maU88MNIdY/eZWowKv/3ZzENQAJYVSOoDKRM5prZ4UMml4xIv4c=
  -----END RSA PRIVATE KEY-----
  """

  @decoded_pem {
    :RSAPrivateKey,
    :"two-prime",
    22_178_836_200_351_380_318_740_579_128_076_760_436_035_138_298_677_133_998_095_994_045_880_250_237_512_489_621_454_049_374_968_347_715_235_055_783_881_967_698_436_999_743_499_552_314_220_245_159_073_073_380_722_782_484_638_674_394_343_203_468_456_842_721_969_160_490_509_408_462_854_393_345_405_217_052_033_027_002_266_498_826_680_781_860_593_217_442_724_766_608_969_408_399_340_485_759_397_900_671_701_217_164_071_787_627_996_052_566_922_654_086_785_056_460_976_416_517_428_062_469_453_531_934_201_888_286_810_352_377_976_660_566_632_576_939_435_504_625_681_508_553_755_882_812_006_916_212_863_287_750_386_635_961_610_258_614_389_401_711_948_452_227_087_543_533_788_958_800_504_728_999_838_598_664_499_003_820_759_527_927_048_804_714_300_161_960_621_149_036_100_364_182_740_694_238_727_122_433_513_404_946_091_683_042_703,
    65537,
    18_953_722_005_479_038_672_989_358_915_211_180_275_890_260_321_558_970_411_086_292_300_953_891_314_102_903_798_293_741_601_596_842_249_220_589_427_161_410_575_497_215_994_540_174_656_492_260_412_045_190_058_045_697_523_798_132_914_292_381_351_875_465_619_868_574_569_967_505_985_612_493_829_380_502_486_125_604_518_301_719_636_021_034_677_605_693_414_631_216_007_271_459_728_426_119_381_823_980_696_705_221_015_479_522_156_363_868_435_684_783_617_296_463_247_438_499_300_802_671_603_744_372_814_426_304_362_919_053_721_052_072_690_042_881_679_754_394_100_902_833_620_569_116_419_541_999_627_788_678_348_085_500_419_601_780_112_784_642_580_771_348_412_671_226_267_444_389_048_117_048_054_825_692_970_232_535_861_820_613_163_424_630_322_678_634_426_098_569_280_437_755_714_074_716_898_258_095_743_415_742_430_656_778_272_361,
    152_768_202_594_113_506_003_906_892_512_748_290_305_531_150_912_607_635_622_225_249_629_386_697_488_954_984_355_599_970_491_458_110_778_989_746_505_533_403_503_662_866_670_470_953_760_749_589_017_642_309_508_310_049_856_672_577_159_050_375_653_128_905_845_977_073_586_607_530_375_373_027_518_020_058_386_877_444_130_805_997_536_867_700_689_067_133_764_524_765_224_528_717_473_435_950_253_382_932_149_817_505_499,
    145_179_663_200_449_145_917_521_205_971_590_191_715_095_399_605_877_657_860_535_867_727_166_023_541_655_152_176_425_320_419_506_590_078_056_361_653_718_878_871_175_026_174_125_734_643_334_617_196_310_933_880_264_431_271_402_500_332_782_840_931_546_131_335_362_589_195_212_219_385_352_510_583_753_009_500_018_046_055_463_721_898_551_203_113_792_493_296_805_078_356_511_882_223_907_692_461_773_372_201_488_840_797,
    42_634_396_225_740_208_200_122_939_165_023_822_110_993_251_906_428_332_934_533_161_660_153_542_229_168_052_609_425_568_156_747_621_132_302_706_312_254_237_302_317_680_568_273_093_737_646_062_272_192_469_000_823_821_839_244_113_039_031_865_521_701_141_155_727_614_567_329_168_722_486_117_358_203_562_383_020_102_433_014_048_475_659_707_426_385_673_383_785_616_612_854_269_230_955_697_241_777_527_641_182_266_133,
    101_920_611_626_859_098_746_040_147_787_461_939_524_540_705_867_934_527_984_274_451_657_219_304_776_355_522_780_797_909_077_026_392_768_989_962_056_944_197_903_228_585_062_565_435_177_154_621_093_200_325_875_415_203_905_670_958_966_858_503_264_102_811_489_825_554_515_502_983_073_693_999_716_921_620_063_267_013_762_696_345_283_281_845_431_778_671_957_714_037_110_407_177_460_667_546_919_659_598_114_321_682_045,
    113_504_902_981_879_519_219_294_186_506_942_993_139_718_372_538_463_522_557_610_536_232_722_856_450_238_191_548_259_358_573_620_555_616_453_272_575_244_746_754_527_476_128_589_876_390_856_908_911_294_135_573_670_756_100_331_272_684_920_761_429_283_802_284_667_615_556_476_745_952_741_230_523_406_386_621_965_212_672_405_641_392_988_569_738_039_218_761_014_896_354_457_746_693_861_804_733_309_700_621_570_981_767,
    :asn1_NOVALUE
  }

  @known_hosts """
  github.com,192.30.252.128 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==
  """

  @host_key {
    :RSAPublicKey,
    21_634_204_163_197_213_132_817_109_123_906_975_906_368_888_521_544_012_567_769_262_995_559_431_966_147_970_056_259_890_368_935_740_096_079_275_379_887_017_970_430_632_559_083_119_648_736_096_672_444_000_478_892_100_121_400_122_505_155_635_695_213_610_246_722_639_150_597_148_186_404_829_574_795_017_869_184_029_845_276_838_222_700_401_896_051_725_788_665_083_080_114_314_875_103_545_837_696_279_553_436_341_967_388_240_785_773_957_395_421_170_074_137_268_759_810_304_409_727_303_757_139_265_883_118_481_355_074_238_232_002_946_450_070_460_602_471_201_997_377_623_196_017_810_991_617_729_908_588_802_783_067_540_409_316_213_603_919_494_955_068_312_762_445_623_851_275_603_318_105_356_333_614_840_694_877_780_018_045_461_415_298_887_693_169_943_421_044_958_989_561_462_337_777_142_733_008_105_081_260_079_805_978_461_159_529,
    35
  }

  @tmp_dir "./test/temp"

  setup_all do
    File.mkdir_p!(@tmp_dir)
    on_exit(fn -> File.rm_rf!(@tmp_dir) end)
  end

  setup do
    {:ok, known_hosts} = StringIO.open(@known_hosts)
    {:ok, key} = StringIO.open(@key)

    %{
      known_hosts: known_hosts,
      key: key
    }
  end

  test "add_host_key writes an entry to known hosts if accept_hosts is true" do
    {:ok, known_hosts} = StringIO.open("")

    ConfigurableClientKeys.add_host_key(
      "example.com",
      @host_key,
      key_cb_private: [accept_hosts: true, known_hosts: known_hosts]
    )

    result = StringIO.flush(known_hosts)
    assert result =~ "example.com"
  end

  test "add_host_key returns an error if accept_hosts is false" do
    {:ok, known_hosts} = StringIO.open("")

    result =
      ConfigurableClientKeys.add_host_key(
        "example.com",
        @host_key,
        key_cb_private: [accept_hosts: false, known_hosts: known_hosts]
      )

    assert {:error, _message} = result
  end

  test "is_host_key returns true if host and key match known hosts entry", %{
    known_hosts: known_hosts
  } do
    result =
      ConfigurableClientKeys.is_host_key(
        @host_key,
        ~c"github.com",
        nil,
        key_cb_private: [accept_hosts: false, known_hosts: known_hosts]
      )

    assert result
  end

  test "is_host_key returns false if host and key do not match known hosts entry", %{
    known_hosts: known_hosts
  } do
    result =
      ConfigurableClientKeys.is_host_key(
        @host_key,
        ~c"other.com",
        nil,
        key_cb_private: [accept_hosts: false, known_hosts: known_hosts]
      )

    refute result
  end

  test "user key returns the contents of the key option", %{key: key} do
    result =
      ConfigurableClientKeys.user_key(
        nil,
        key_cb_private: [key: key]
      )

    assert result == {:ok, @decoded_pem}
  end

  test "get_cb_module returns IO devices for the specified files" do
    key_file = Path.join(@tmp_dir, "./foo")
    known_hosts_file = Path.join(@tmp_dir, "./bar")
    File.touch(key_file)
    File.touch(known_hosts_file)

    {_module, opts} =
      ConfigurableClientKeys.get_cb_module(key_file: key_file, known_hosts_file: known_hosts_file)

    assert opts[:key_file]
    assert opts[:known_hosts_file]
  end
end
